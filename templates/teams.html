{% extends "base.html" %}

{% block title %}Dru≈ºyny - CS2 Tracker{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto;">

    <div class="card" style="text-align: center; margin-bottom: 20px;">
        <h1>Dru≈ºyny</h1>
        <p>ZarzƒÖdzaj zespo≈Çami biorƒÖcymi udzia≈Ç w turniejach.</p>
    </div>

    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>Lista Dru≈ºyn</h2>
            <button onclick="openAddTeamModal()" class="btn" style="background-color: #27ae60;">
                + Dodaj Dru≈ºynƒô
            </button>
        </div>

        <div class="player-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px;">
            {% for team in teams %}
            <div class="player-card" style="background: white; border: 1px solid #eee; border-radius: 8px; padding: 20px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">

                <div style="height: 100px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                    {% if team.logo_url %}
                    <img src="{{ team.logo_url }}" alt="{{ team.name }}" style="max-height: 100%; max-width: 100%; object-fit: contain;">
                    {% else %}
                    <div style="font-size: 3rem;">üõ°Ô∏è</div>
                    {% endif %}
                </div>

                <h3 style="margin: 10px 0;">{{ team.name }}</h3>
                <p style="color: #7f8c8d; font-size: 0.9rem;">Liczba graczy: {{ team.players|length }}</p>

                <div style="margin-top: 15px; display: flex; gap: 5px; justify-content: center;">
                    <button onclick='openEditTeamModal({id: {{ team.id }}, name: "{{ team.name }}", logo_url: "{{ team.logo_url or "" }}"})'
                            class="btn" style="background-color: #f39c12; font-size: 0.8rem; padding: 5px 10px;">Edytuj</button>
                    <button onclick="deleteTeam({{ team.id }})"
                            class="btn" style="background-color: #c0392b; font-size: 0.8rem; padding: 5px 10px;">Usu≈Ñ</button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<div id="teamModal" style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000;">
    <div style="background: white; padding: 25px; border-radius: 8px; width: 400px; max-width: 90%; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        <h2 id="modalTitle" style="margin-top: 0;">Dodaj Dru≈ºynƒô</h2>

        <form id="teamForm" onsubmit="submitTeamForm(event)">
            <input type="hidden" id="teamId"> <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Nazwa:</label>
                <input type="text" name="name" id="teamName" required style="width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Logo URL:</label>
                <input type="url" name="logo_url" id="teamLogo" placeholder="https://..." style="width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px;">
            </div>

            <div style="text-align: right;">
                <button type="button" class="btn" style="background: #95a5a6; margin-right: 5px;" onclick="closeTeamModal()">Anuluj</button>
                <button type="submit" class="btn" style="background: #27ae60;">Zapisz</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_script %}
<script>
    const modal = document.getElementById('teamModal');
    const modalTitle = document.getElementById('modalTitle');
    const teamIdInput = document.getElementById('teamId');
    const nameInput = document.getElementById('teamName');
    const logoInput = document.getElementById('teamLogo');

    function openAddTeamModal() {
        modalTitle.innerText = "Dodaj Dru≈ºynƒô";
        teamIdInput.value = "";
        nameInput.value = "";
        logoInput.value = "";
        modal.style.display = 'flex';
    }

    function openEditTeamModal(team) {
        modalTitle.innerText = "Edytuj Dru≈ºynƒô";
        teamIdInput.value = team.id;
        nameInput.value = team.name;
        logoInput.value = team.logo_url;
        modal.style.display = 'flex';
    }

    function closeTeamModal() {
        modal.style.display = 'none';
    }

    async function submitTeamForm(event) {
        event.preventDefault();

        const id = teamIdInput.value;
        const isEdit = !!id;

        const data = {
            name: nameInput.value,
            logo_url: logoInput.value || null
        };

        const url = isEdit ? `/api/teams/${id}` : "/api/teams/";
        const method = isEdit ? "PUT" : "POST";

        try {
            const response = await fetch(url, {
                method: method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                window.location.reload();
            } else {
                const err = await response.json();
                // Tutaj obs≈Çu≈ºymy Tw√≥j b≈ÇƒÖd 400
                alert("B≈ÇƒÖd: " + (err.detail || "Nie uda≈Ço siƒô zapisaƒá dru≈ºyny."));
            }
        } catch (e) {
            console.error(e);
            alert("B≈ÇƒÖd po≈ÇƒÖczenia z serwerem.");
        }
    }

    async function deleteTeam(id) {
        if (!confirm("Czy na pewno chcesz usunƒÖƒá tƒô dru≈ºynƒô? Spowoduje to usuniƒôcie powiƒÖzanych danych!")) return;

        try {
            const response = await fetch(`/api/teams/${id}`, {
                method: "DELETE"
            });

            if (response.ok) {
                window.location.reload();
            } else {
                alert("B≈ÇƒÖd usuwania");
            }
        } catch (e) {
            alert("B≈ÇƒÖd sieci");
        }
    }

    window.onclick = function(event) {
        if (event.target === modal) {
            closeTeamModal();
        }
    }
</script>
{% endblock %}