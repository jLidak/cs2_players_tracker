{% extends "base.html" %}

{% block title %}{{ tournament.name }}{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1>{{ tournament.name }}</h1>
        <span class="badge" style="font-size: 1rem; background: #8e44ad;">{{ tournament.bracket_type }}</span>
    </div>

    <div style="margin-top: 10px; font-size: 0.9rem; color: #555;">
        <strong>Waga Turnieju:</strong> {{ tournament.weight }} <br>
        <strong>Wagi Faz:</strong>
        Group: {{ tournament.weight_group }} |
        QF: {{ tournament.weight_quarters }} |
        SF: {{ tournament.weight_semis }}
        {% if tournament.weight_semis_override %}<span style="color:#16a085;">({{ tournament.weight_semis_override }})</span>{% endif %} |
        Final: {{ tournament.weight_final }}
        {% if tournament.weight_final_override %}<span style="color:#16a085;">({{ tournament.weight_final_override }})</span>{% endif %}
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-top: 20px;">

    <div class="card">
        <h3>Uczestnicy i Rundy</h3>

        <div style="background: #f1f1f1; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
            <strong style="display:block; margin-bottom:5px;">Dodaj nową drużynę:</strong>
            <form onsubmit="addTeam(event)" style="display: flex; gap: 5px; flex-wrap: wrap;">
                <select name="team_id" style="flex-grow: 1; padding: 5px;">
                    {% for team in all_teams %}
                    <option value="{{ team.id }}">{{ team.name }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn" style="font-size: 0.8rem;">Dodaj</button>

                {% if tournament.bracket_type == "Bracket 6 teams" %}
                <div style="width: 100%; margin-top: 5px;">
                    <input type="checkbox" name="starts_in_semis" id="semisCheck">
                    <label for="semisCheck">Start w półfinale</label>
                </div>
                {% endif %}
            </form>
        </div>

        <ul style="list-style: none; padding: 0;">
            {% for p in participations %}
            <li style="padding: 10px; border-bottom: 1px solid #eee;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px;">
                    <strong style="font-size: 1.1em;">{{ p.team.name }}</strong>
                    <button onclick="removeTeam({{ p.team.id }})" style="background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 0.7rem;">Usuń</button>
                </div>

                {% if p.starts_in_semis %}
                <div style="font-size: 0.75rem; color: green; margin-bottom: 5px;">(Start w Półfinale)</div>
                {% endif %}

                <form onsubmit="updateTeamStats(event, {{ p.team.id }}, {{ p.starts_in_semis|lower }})" style="display: grid; grid-template-columns: repeat(4, 1fr) auto; gap: 5px; align-items: end;">

                    <div style="text-align: center;">
                        <label style="font-size: 0.7rem; display:block;">Group</label>
                        <input type="number" name="rounds_group" value="{{ p.rounds_group }}" min="0" style="width: 100%; padding: 3px; text-align: center;">
                    </div>

                    {% if p.starts_in_semis %}
                         <div style="text-align: center; opacity: 0.5;">
                            <label style="font-size: 0.7rem; display:block;">QF</label>
                            <input type="number" value="0" disabled style="width: 100%; padding: 3px; text-align: center; background: #eee;">
                        </div>
                    {% else %}
                        <div style="text-align: center;">
                            <label style="font-size: 0.7rem; display:block;">QF</label>
                            <input type="number" name="rounds_quarters" value="{{ p.rounds_quarters }}" min="0" style="width: 100%; padding: 3px; text-align: center;">
                        </div>
                    {% endif %}

                    <div style="text-align: center;">
                        <label style="font-size: 0.7rem; display:block;">SF</label>
                        <input type="number" name="rounds_semis" value="{{ p.rounds_semis }}" min="0" style="width: 100%; padding: 3px; text-align: center;">
                    </div>

                    <div style="text-align: center;">
                        <label style="font-size: 0.7rem; display:block;">Final</label>
                        <input type="number" name="rounds_final" value="{{ p.rounds_final }}" min="0" style="width: 100%; padding: 3px; text-align: center;">
                    </div>

                    <button type="submit" class="btn" style="padding: 4px 8px; font-size: 0.8rem; background-color: #3498db; height: 28px;">Zapisz</button>
                </form>
            </li>
            {% else %}
            <li style="color: #888; text-align: center; padding: 10px;">Brak drużyn.</li>
            {% endfor %}
        </ul>
    </div>

    <div class="card">
        <h3>Wyniki Graczy (Ratingi)</h3>
        <div style="overflow-x: auto;">
            <table class="table">
                <thead>
                    <tr>
                        <th>Gracz</th>
                        <th>Drużyna</th>
                        <th>Group</th>
                        <th>Quarter</th>
                        <th>Semi</th>
                        <th>Final</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for player in players %}
                    {% set perf = perfs_dict.get(player.id) %}
                    <tr id="row-{{ player.id }}">
                        <td>
                            <div style="font-weight: bold;">{{ player.nickname }}</div>
                        </td>
                        <td style="font-size: 0.8rem;">{{ player.team.name }}</td>

                        <td><input type="number" step="0.01" class="rating-input" data-field="rating_group" value="{{ perf.rating_group if perf and perf.rating_group else '' }}" style="width: 80px; padding: 5px;"></td>

                        <td style="text-align: center;">
                            {% if player.team_id in semis_team_ids %}
                                <span style="font-size: 0.8rem; color: #ccc; font-style: italic;">Skip</span>
                                <input type="hidden" class="rating-input" data-field="rating_quarters" value="">
                            {% else %}
                                <input type="number" step="0.01" class="rating-input" data-field="rating_quarters" value="{{ perf.rating_quarters if perf and perf.rating_quarters else '' }}" style="width: 80px; padding: 5px;">
                            {% endif %}
                        </td>

                        <td><input type="number" step="0.01" class="rating-input" data-field="rating_semis" value="{{ perf.rating_semis if perf and perf.rating_semis else '' }}" style="width: 80px; padding: 5px;"></td>
                        <td><input type="number" step="0.01" class="rating-input" data-field="rating_final" value="{{ perf.rating_final if perf and perf.rating_final else '' }}" style="width: 80px; padding: 5px;"></td>

                        <td>
                            <button onclick="saveRating({{ player.id }})" class="btn" style="background: #27ae60; padding: 5px 10px; font-size: 0.8rem;">Zapisz</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_script %}
<script>
    const TOURNAMENT_ID = {{ tournament.id }};

    // --- DODAWANIE DRUŻYNY ---
    async function addTeam(event) {
        event.preventDefault();
        const form = event.target;
        const teamId = form.team_id.value;

        let startsInSemis = false;
        if (form.starts_in_semis) {
            startsInSemis = form.starts_in_semis.checked;
        }

        try {
            const response = await fetch(`/api/tournaments/${TOURNAMENT_ID}/add_team`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    team_id: parseInt(teamId),
                    starts_in_semis: startsInSemis
                })
            });

            if (response.ok) {
                window.location.reload();
            } else {
                alert("Błąd dodawania drużyny");
            }
        } catch (e) {
            console.error(e);
            alert("Błąd połączenia");
        }
    }

    // --- NOWE: USUWANIE DRUŻYNY ---
    async function removeTeam(teamId) {
        if (!confirm("Czy na pewno usunąć tę drużynę z turnieju? Usunie to również wszystkie wpisane wyniki graczy tej drużyny!")) {
            return;
        }

        try {
            const response = await fetch(`/api/tournaments/${TOURNAMENT_ID}/teams/${teamId}`, {
                method: "DELETE"
            });

            if (response.ok) {
                window.location.reload();
            } else {
                const err = await response.json();
                alert("Błąd: " + (err.detail || "Nie udało się usunąć drużyny"));
            }
        } catch (e) {
            console.error(e);
            alert("Błąd sieci");
        }
    }

    // --- ZAPISYWANIE RATINGÓW ---
    async function saveRating(playerId) {
        const row = document.getElementById(`row-${playerId}`);
        const inputs = row.querySelectorAll('.rating-input');

        const data = {
            player_id: playerId,
            tournament_id: TOURNAMENT_ID,
            rating_group: inputs[0].value ? parseFloat(inputs[0].value) : null,
            rating_quarters: inputs[1].value ? parseFloat(inputs[1].value) : null,
            rating_semis: inputs[2].value ? parseFloat(inputs[2].value) : null,
            rating_final: inputs[3].value ? parseFloat(inputs[3].value) : null
        };

        const btn = row.querySelector('button');
        const originalText = btn.innerText;
        btn.innerText = "⏳";
        btn.disabled = true;

        try {
            const response = await fetch("/api/performances/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                btn.innerText = "✔";
                btn.style.backgroundColor = "#2ecc71";
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.style.backgroundColor = "#27ae60";
                    btn.disabled = false;
                }, 1500);
            } else {
                btn.innerText = "❌";
                alert("Błąd zapisu!");
                btn.disabled = false;
            }
        } catch (e) {
            console.error(e);
            alert("Błąd sieci");
            btn.disabled = false;
        }
    }

    // --- NOWE: AKTUALIZACJA STATYSTYK DRUŻYNY (RUNDY) ---
    async function updateTeamStats(event, teamId, startsInSemis) {
        event.preventDefault();
        const form = event.target;
        const btn = form.querySelector('button[type="submit"]');
        const originalText = btn.innerText;

        btn.innerText = "...";
        btn.disabled = true;

        const data = {
            team_id: teamId,
            starts_in_semis: startsInSemis,
            rounds_group: parseInt(form.rounds_group.value) || 0,
            rounds_quarters: form.rounds_quarters ? (parseInt(form.rounds_quarters.value) || 0) : 0,
            rounds_semis: parseInt(form.rounds_semis.value) || 0,
            rounds_final: parseInt(form.rounds_final.value) || 0
        };

        try {
            // Używamy tego samego endpointu co dodawanie, on obsługuje "upsert" (update jeśli istnieje)
            const response = await fetch(`/api/tournaments/${TOURNAMENT_ID}/add_team`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                btn.innerText = "OK";
                btn.style.backgroundColor = "#2ecc71";
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.style.backgroundColor = "#3498db";
                    btn.disabled = false;
                }, 1000);
            } else {
                alert("Błąd zapisu rund");
                btn.innerText = "Błąd";
                btn.disabled = false;
            }
        } catch (e) {
            console.error(e);
            alert("Błąd połączenia");
            btn.disabled = false;
        }
    }
</script>
{% endblock %}