{% extends "base.html" %}

{% block title %}{{ player.nickname }} - Profil{% endblock %}

{% block content %}
<div class="card" style="max-width: 800px; margin: 0 auto;">

    <div style="display: flex; gap: 30px; align-items: flex-start;">
        <div style="flex-shrink: 0;">
            {% if player.photo_url %}
            <img src="{{ player.photo_url }}" alt="{{ player.nickname }}"
                 style="width: 200px; height: 200px; object-fit: cover; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
            {% else %}
            <div style="width: 200px; height: 200px; background: #eee; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 5rem; color: #ccc;">
                ðŸ‘¤
            </div>
            {% endif %}
        </div>

        <div style="flex-grow: 1;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <h1 style="margin-top: 0; font-size: 2.5rem; margin-bottom: 10px;">{{ player.nickname }}</h1>

                <button onclick="openEditModal()" class="btn" style="background-color: #f39c12; font-size: 0.9rem; padding: 8px 15px;">
                    âœŽ Edytuj Profil
                </button>
            </div>

            <h3 style="color: #666; margin-top: 0;">
                {% if player.team %}
                    Team: <span style="color: #333;">{{ player.team.name }}</span>
                {% else %}
                    <span style="color: #999;">Brak druÅ¼yny</span>
                {% endif %}
            </h3>

            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <strong>Statystyki Turniejowe:</strong>
                <ul style="margin-top: 10px; padding-left: 20px;">
                    {% for perf in player.tournament_performances %}
                    <li style="margin-bottom: 5px;">
                        <strong>{{ perf.tournament.name }}:</strong>
                        <span style="color: #27ae60;">
                            {% if perf.rating_group %}Grp: {{ perf.rating_group }}{% endif %}
                            {% if perf.rating_quarters %} | QF: {{ perf.rating_quarters }}{% endif %}
                            {% if perf.rating_semis %} | SF: {{ perf.rating_semis }}{% endif %}
                            {% if perf.rating_final %} | F: {{ perf.rating_final }}{% endif %}
                        </span>
                    </li>
                    {% else %}
                    <li style="color: #888;">Brak danych z turniejÃ³w.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<div id="editPlayerModal" style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000;">
    <div style="background: white; padding: 25px; border-radius: 8px; width: 400px; max-width: 90%; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        <h2 style="margin-top: 0;">Edytuj profil gracza</h2>

        <form onsubmit="submitEditPlayer(event)">
            <input type="hidden" id="editPlayerId" value="{{ player.id }}">

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Nick:</label>
                <input type="text" name="nickname" id="editNickname" value="{{ player.nickname }}" required style="width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">DruÅ¼yna:</label>
                <select name="team_id" id="editTeamId" style="width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px;">
                    <option value="">-- Brak druÅ¼yny --</option>
                    {% for team in all_teams %}
                    <option value="{{ team.id }}" {% if player.team_id == team.id %}selected{% endif %}>{{ team.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Link do zdjÄ™cia:</label>
                <input type="url" name="photo_url" id="editPhotoUrl" value="{{ player.photo_url or '' }}" placeholder="https://..." style="width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px;">
            </div>

            <div style="text-align: right;">
                <button type="button" class="btn" style="background: #95a5a6; margin-right: 5px;" onclick="closeEditModal()">Anuluj</button>
                <button type="submit" class="btn" style="background: #27ae60;">Zapisz zmiany</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_script %}
<script>
    function openEditModal() {
        document.getElementById('editPlayerModal').style.display = 'flex';
    }

    function closeEditModal() {
        document.getElementById('editPlayerModal').style.display = 'none';
    }

    async function submitEditPlayer(event) {
        event.preventDefault();
        const playerId = document.getElementById('editPlayerId').value;
        const formData = new FormData(event.target);

        const teamIdVal = formData.get("team_id");

        const data = {
            nickname: formData.get("nickname"),
            team_id: (teamIdVal && teamIdVal !== "") ? parseInt(teamIdVal) : null,
            photo_url: formData.get("photo_url") || null
        };

        try {
            const response = await fetch(`/api/players/${playerId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                window.location.reload();
            } else {
                const err = await response.json();
                alert("BÅ‚Ä…d: " + (err.detail || "WystÄ…piÅ‚ bÅ‚Ä…d podczas edycji"));
            }
        } catch (e) {
            console.error(e);
            alert("BÅ‚Ä…d poÅ‚Ä…czenia z serwerem.");
        }
    }

    // Zamknij modal po klikniÄ™ciu poza nim
    window.onclick = function(event) {
        const modal = document.getElementById('editPlayerModal');
        if (event.target === modal) {
            closeEditModal();
        }
    }
</script>
{% endblock %}