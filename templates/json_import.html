{% extends "base.html" %}

{% block title %}ZarzÄ…dzanie Danymi{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto;">

    <div class="card" style="text-align: center; margin-bottom: 30px;">
        <h1>Import / Export Bazy Danych</h1>
        <p>ZarzÄ…dzaj kopiami zapasowymi caÅ‚ej aplikacji.</p>
    </div>

    <div class="card" style="margin-bottom: 20px; border-left: 5px solid #3498db;">
        <h2>ðŸ“¤ Eksport (Backup)</h2>
        <p>Pobierz caÅ‚Ä… zawartoÅ›Ä‡ bazy danych (druÅ¼yny, gracze, turnieje, mecze, wyniki) do jednego pliku JSON.</p>
        <a href="/api/export" class="btn" style="background-color: #3498db; text-decoration: none; display: inline-block;">
            Pobierz peÅ‚ny backup (.json)
        </a>
    </div>

    <div class="card" style="margin-bottom: 20px; border-left: 5px solid #e74c3c;">
        <h2>ðŸ“¥ Import (Przywracanie)</h2>
        <p style="color: #c0392b; font-weight: bold;">UWAGA: Ta operacja usunie wszystkie obecne dane i zastÄ…pi je danymi z pliku!</p>

        <form onsubmit="importDatabase(event)" style="margin-top: 15px;">
            <input type="file" id="importFile" accept=".json" required style="padding: 10px; border: 1px solid #ddd; width: 100%; box-sizing: border-box; margin-bottom: 10px;">
            <button type="submit" class="btn" style="background-color: #e74c3c; width: 100%;">
                Wgraj plik i nadpisz bazÄ™
            </button>
        </form>
    </div>

    <div class="card" style="border-left: 5px solid #2ecc71;">
        <h2>ðŸ”„ Dane Startowe</h2>
        <p>ZaÅ‚aduj domyÅ›lne dane z plikÃ³w serwerowych (folder <code>json_import_files</code>). Bezpieczne - nie usuwa istniejÄ…cych danych, tylko dodaje nowe.</p>
        <button onclick="autoImportFromFiles()" class="btn" style="background-color: #2ecc71; width: 100%;">
            ZaÅ‚aduj wstÄ™pnÄ… bazÄ™
        </button>
    </div>

</div>
{% endblock %}

{% block extra_script %}
<script>
    async function importDatabase(event) {
        event.preventDefault();

        if (!confirm("CZY JESTEÅš PEWIEN? To usunie WSZYSTKIE obecne dane z bazy i zastÄ…pi je zawartoÅ›ciÄ… pliku. Tej operacji nie moÅ¼na cofnÄ…Ä‡.")) {
            return;
        }

        const fileInput = document.getElementById('importFile');
        const formData = new FormData();
        formData.append("file", fileInput.files[0]);

        const btn = event.target.querySelector('button');
        const originalText = btn.innerText;
        btn.innerText = "Trwa importowanie...";
        btn.disabled = true;

        try {
            const response = await fetch('/api/import', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                alert("Sukces! Baza danych zostaÅ‚a przywrÃ³cona.");
                window.location.reload();
            } else {
                const err = await response.json();
                alert("BÅ‚Ä…d: " + (err.detail || "WystÄ…piÅ‚ bÅ‚Ä…d podczas importu"));
            }
        } catch (e) {
            console.error(e);
            alert("BÅ‚Ä…d poÅ‚Ä…czenia z serwerem.");
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    async function autoImportFromFiles() {
        if (!confirm("Czy chcesz zaÅ‚adowaÄ‡ dane startowe?")) return;

        try {
            const response = await fetch('/api/import/auto-from-files', { method: 'POST' });
            const data = await response.json();
            if (response.ok) {
                alert(data.message);
                window.location.reload();
            } else {
                alert("BÅ‚Ä…d: " + data.detail);
            }
        } catch (e) {
            alert("BÅ‚Ä…d sieci.");
        }
    }
</script>
{% endblock %}